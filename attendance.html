/* ===== Attendance Handler (Geo-Fenced, Role & Shift Validation) ===== */
function doPost(e) {
  try {
    var params = e.parameter;
    var empId = params.empId;
    var shift = params.shift;
    var latitude = parseFloat(params.latitude);
    var longitude = parseFloat(params.longitude);
    var action = params.action; // "Check-In" or "Check-Out"
    var timestamp = new Date(params.timestamp);

    if (!empId || !shift || isNaN(latitude) || isNaN(longitude) || !action) {
      throw new Error("Missing or invalid parameters");
    }

    var ss = SpreadsheetApp.getActiveSpreadsheet();

    // ----- EMPLOYEE SHEET -----
    var empSheet = ss.getSheetByName("Employees");
    if (!empSheet) throw new Error("Employees sheet missing");
    var empData = empSheet.getDataRange().getValues();
    var headers = empData[0].map(h => h.toString().toLowerCase());
    var colEmpId = headers.indexOf("empid");
    var colName  = headers.indexOf("name");
    var colRole  = headers.indexOf("role");
    var colOffice= headers.indexOf("office");
    if ([colEmpId,colName,colRole,colOffice].includes(-1)) throw new Error("Employee sheet missing required headers");

    var emp = null;
    for (var i = 1; i < empData.length; i++) {
      if (empData[i][colEmpId].toString().toUpperCase() === empId.toUpperCase()) {
        emp = {
          name: empData[i][colName],
          role: empData[i][colRole].toLowerCase(),
          office: empData[i][colOffice]
        };
        break;
      }
    }
    if (!emp) throw new Error("Employee not found");

    // ----- SHIFT VALIDATION -----
    var allowedShifts = { inbound:["night"], outbound:["morning","evening"] };
    if (!allowedShifts[emp.role]?.includes(shift.toLowerCase())) {
      throw new Error("Shift not allowed for role: " + emp.role);
    }

    // ----- OFFICE LOCATION -----
    var officeSheet = ss.getSheetByName("Offices");
    if (!officeSheet) throw new Error("Offices sheet missing");
    var officeData = officeSheet.getDataRange().getValues();
    var officeLat = null, officeLng = null;
    for (var j=1;j<officeData.length;j++){
      if (officeData[j][0].toString() === emp.office){
        officeLat = parseFloat(officeData[j][1]);
        officeLng = parseFloat(officeData[j][2]);
        break;
      }
    }
    if (officeLat===null || officeLng===null) throw new Error("Office location not found");

    // ----- GEO-FENCE (200m) -----
    var distance = getDistanceInMeters(officeLat, officeLng, latitude, longitude);
    if (distance > 200) throw new Error("Outside office area (" + Math.round(distance) + " m)");

    // ----- ATTENDANCE SHEET -----
    var attSheet = ss.getSheetByName("Attendance");
    if (!attSheet) throw new Error("Attendance sheet missing");
    var data = attSheet.getDataRange().getValues();
    var today = new Date(); today.setHours(0,0,0,0);
    var foundRow = null;
    for (var k=1;k<data.length;k++){
      var rowDate = new Date(data[k][0]); rowDate.setHours(0,0,0,0);
      if (data[k][1].toString().toUpperCase()===empId.toUpperCase() && rowDate.getTime()===today.getTime()){
        foundRow = k+1;
        break;
      }
    }

    if (action==="Check-In") {
      if (foundRow) throw new Error("Already checked in today");
      attSheet.appendRow([
        today, empId, emp.name, emp.role, emp.office,
        timestamp, shift, "", "", latitude, longitude, "", ""
      ]);
    } else if (action==="Check-Out") {
      if (!foundRow) throw new Error("No check-in found for today");
      attSheet.getRange(foundRow,8).setValue(timestamp);   // Check-Out Time
      attSheet.getRange(foundRow,9).setValue(shift);       // Check-Out Shift
      attSheet.getRange(foundRow,12).setValue(latitude);   // Check-Out Lat
      attSheet.getRange(foundRow,13).setValue(longitude);  // Check-Out Lng
    }

    return ContentService.createTextOutput(
      JSON.stringify({ success:true, message: action + " successful" })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch(err){
    return ContentService.createTextOutput(
      JSON.stringify({ success:false, message: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

/* ===== DISTANCE FUNCTION ===== */
function getDistanceInMeters(lat1, lon1, lat2, lon2){
  var R=6371000;
  var dLat=(lat2-lat1)*Math.PI/180;
  var dLon=(lon2-lon1)*Math.PI/180;
  var a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*(Math.sin(dLon/2)**2);
  var c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

/* ===== FETCH EMPLOYEES ===== */
function getAllEmployees() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var empSheet = ss.getSheetByName("Employees");
  if (!empSheet) return {success:false,message:"Employee sheet missing"};
  var empData = empSheet.getDataRange().getValues();
  var headers = empData[0].map(h=>h.toString().toLowerCase());
  var colEmpId = headers.indexOf("empid");
  var colName  = headers.indexOf("name");
  var colRole  = headers.indexOf("role");
  if ([colEmpId,colName,colRole].includes(-1)) return {success:false,message:"Invalid headers"};
  var employees = empData.slice(1).map(r=>({empId:r[colEmpId],name:r[colName],role:r[colRole]}));
  return {success:true,employees:employees};
}
