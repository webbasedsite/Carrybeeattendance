<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carrybee Attendance</title>
<style>
  /* ====== BODY & LAYOUT ====== */
  body, html { margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f7fa; color:#000; display:flex; flex-direction:column; align-items:center; padding:20px; transition: background 0.3s, color 0.3s;}
  .dark-mode { background:#121212; color:#f5f7fa;}
  header { font-size:2rem; font-weight:700; margin-bottom:15px; color:#2575fc; text-shadow:0 1px 3px rgba(255,223,0,0.6); border-bottom:2px solid #FFDF00; padding-bottom:10px; width:100%; max-width:380px; text-align:center;}
  
  /* ====== NAV ====== */
  nav { background:#2575fc; color:white; width:100%; max-width:380px; padding:10px 0; display:flex; justify-content:space-around; border-radius:8px; margin-bottom:20px; }
  nav button { background:none; border:none; color:white; font-size:1rem; font-weight:600; cursor:pointer; }
  nav button:hover { text-decoration:underline; }
  #darkModeToggle { background:#6a11cb; padding:5px 10px; border-radius:6px; font-size:0.9rem; }

  /* ====== CONTAINER ====== */
  .container { background:white; padding:25px 30px; border-radius:15px; box-shadow:0 8px 24px rgba(37,117,252,0.15); max-width:380px; width:100%; transition: background 0.3s, box-shadow 0.3s;}
  .dark-mode .container { background:#1e1e1e; box-shadow:0 8px 24px rgba(255,255,255,0.1);}
  label { font-weight:600; font-size:1rem; color:#2575fc; display:block; margin-bottom:10px; text-align:left; }
  input[type="text"], select { width:100%; padding:10px 14px; font-size:0.95rem; border-radius:12px; border:2px solid #2575fc; margin-bottom:20px; outline:none; background:#fff; box-shadow:0 4px 12px rgba(37,117,252,0.1); transition: all 0.4s ease; }
  .dark-mode input, .dark-mode select { background:#2c2c2c; color:#f5f7fa; border-color:#6a11cb; box-shadow:0 4px 12px rgba(255,255,255,0.05);}
  input:focus, select:focus { border-color:transparent; background:linear-gradient(white, white) padding-box, linear-gradient(135deg,#2575fc,#6a11cb) border-box; box-shadow:0 8px 20px rgba(37,117,252,0.35),0 0 0 4px rgba(37,117,252,0.15); transform:scale(1.03);}
  button { background:#2575fc; color:white; border:none; border-radius:8px; padding:15px 0; width:100%; font-size:1.1rem; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(37,117,252,0.5); transition:background-color 0.3s, box-shadow 0.3s; }
  button:disabled { opacity:0.6; cursor:not-allowed; }
  #welcome { font-weight:700; font-size:1.3rem; margin-bottom:8px; color:#2575fc; }
  #status { margin-top:20px; font-weight:600; min-height:1.2em; color:#d8000c; }

  .spinner { border:4px solid #f3f3f3; border-top:4px solid #2575fc; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; display:inline-block; margin-left:8px;}
  @keyframes spin { 0% { transform:rotate(0deg);} 100% { transform:rotate(360deg);} }

  /* ====== SUCCESS ANIMATION ====== */
  .success-animation { position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#28a745; color:white; padding:15px 25px; border-radius:12px; opacity:0; pointer-events:none; transition:opacity 0.5s ease; font-size:1.2rem; font-weight:600;}
  .success-animation.show { opacity:1;}

  /* ====== MODAL ====== */
  .modal { display:none; position:fixed; z-index:999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
  .modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; max-height:80%; overflow-y:auto; transition:background 0.3s; }
  .dark-mode .modal-content { background:#1e1e1e; color:#f5f7fa;}
  .modal h2 { margin-top:0; color:#2575fc; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  table, th, td { border:1px solid #ddd; text-align:center; padding:6px; }
  table th { background:#2575fc; color:white; }
  .close-btn { float:right; background:red; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>
<header>Carrybee Attendance</header>

<nav>
  <button onclick="viewHistory()">View History</button>
  <button onclick="downloadHistory()">Download CSV</button>
  <button id="darkModeToggle">üåô Dark Mode</button>
</nav>

<div class="container">
  <div id="welcome">Welcome, Guest</div>
  <label for="empId">Employee ID</label>
  <input type="text" id="empId" placeholder="Input ID (CL-86017)" autocomplete="off">

  <label for="shift">Select Shift</label>
  <select id="shift"></select>

  <button id="checkInBtn" onclick="submitAttendance('Check-In')">Check In</button>
  <button id="checkOutBtn" onclick="submitAttendance('Check-Out')" style="margin-top:15px;">Check Out</button>
  <div id="status"></div>
</div>

<div id="successAnim" class="success-animation">‚úîÔ∏è Action Successful!</div>

<!-- HISTORY MODAL -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeHistory()">Back</button>
    <h2>Attendance History</h2>
    <div id="historyContent">Loading...</div>
  </div>
</div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbwP4d7VWkx5NDDAtzbQ3WsaaR87bJhNLWXeUcxTXeRwR1Hf8inOvwNq5Y3wGmtmhRMF/exec";
const empInput = document.getElementById("empId");
const shiftSelect = document.getElementById("shift");
const statusEl = document.getElementById("status");
const welcomeEl = document.getElementById("welcome");
const checkInBtn = document.getElementById("checkInBtn");
const checkOutBtn = document.getElementById("checkOutBtn");
const successAnim = document.getElementById("successAnim");
const darkModeToggle = document.getElementById("darkModeToggle");

let allEmployees = [];
let historyData = [];
const shiftOptions = { "inbound":["Night"], "outbound":["Morning","Evening"] };

// DARK MODE
darkModeToggle.addEventListener("click", ()=>document.body.classList.toggle("dark-mode"));

// FETCH EMPLOYEES
async function fetchAllEmployees(){
  try{
    const resp = await fetch(webAppUrl,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:"action=getAllEmployees"
    });
    const data = await resp.json();
    if(data.success) allEmployees = data.employees||[];
    else statusEl.textContent="Failed to load employees";
  } catch { statusEl.textContent="Error fetching employees"; }
}
fetchAllEmployees();

// UPDATE SHIFTS
function updateShiftOptions(role){
  shiftSelect.innerHTML="";
  (shiftOptions[role.toLowerCase()]||[]).forEach(opt=>{
    const el=document.createElement("option");
    el.value=opt; el.textContent=opt;
    shiftSelect.appendChild(el);
  });
}

// EMPLOYEE INPUT
empInput.addEventListener("input", ()=>{
  const emp = allEmployees.find(e=>e.empId===empInput.value.trim());
  if(emp){ welcomeEl.textContent=`Welcome ${emp.name}`; updateShiftOptions(emp.role); }
  else { welcomeEl.textContent="Welcome, Guest"; shiftSelect.innerHTML=""; }
});

// LOCAL STORAGE
function saveUser(emp){
  localStorage.setItem("empId",emp.empId);
  localStorage.setItem("name",emp.name);
  localStorage.setItem("role",emp.role);
}
function loadUser(){
  const empId = localStorage.getItem("empId"), name = localStorage.getItem("name"), role = localStorage.getItem("role");
  if(empId && name && role){
    empInput.value=empId; empInput.disabled=true; welcomeEl.textContent=`Welcome ${name}`; updateShiftOptions(role);
  }
}
loadUser();

// GEO DISTANCE
function getDistance(lat1, lon1, lat2, lon2){
  const R=6371e3, œÜ1=lat1*Math.PI/180, œÜ2=lat2*Math.PI/180;
  const ŒîœÜ=(lat2-lat1)*Math.PI/180, ŒîŒª=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ATTENDANCE SUBMISSION
async function submitAttendance(action){
  const empId = empInput.value.trim();
  const emp = allEmployees.find(e=>e.empId===empId);
  if(!emp){ statusEl.textContent="Invalid Employee ID"; return; }
  const shift = shiftSelect.value;
  if(!(shiftOptions[emp.role.toLowerCase()]||[]).includes(shift)){ statusEl.textContent=`Shift not allowed for role: ${emp.role}`; return; }

  checkInBtn.disabled=true; checkOutBtn.disabled=true;
  statusEl.innerHTML=`${action} in progress <span class="spinner"></span>`;
  const timestamp = new Date().toISOString();

  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const resp = await fetch(webAppUrl,{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:`action=${action}&empId=${encodeURIComponent(empId)}&shift=${encodeURIComponent(shift)}&latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&timestamp=${timestamp}`
      });
      const data = await resp.json();
      if(data.success){ statusEl.style.color="green"; statusEl.textContent=`${action} successful`; saveUser(emp); showSuccessAnim(); }
      else{ statusEl.style.color="#d8000c"; statusEl.textContent=data.message||`${action} failed`; }
    } catch{ statusEl.style.color="#d8000c"; statusEl.textContent="Error submitting attendance"; }
    finally{ checkInBtn.disabled=false; checkOutBtn.disabled=false; }
  }, ()=>{ statusEl.textContent="Location access denied"; checkInBtn.disabled=false; checkOutBtn.disabled=false; });
}

// SUCCESS ANIMATION
function showSuccessAnim(){
  successAnim.classList.add("show");
  setTimeout(()=>successAnim.classList.remove("show"),2000);
}

// HISTORY MODAL
const modal = document.getElementById("historyModal");
modal.addEventListener("click", e=>{ if(e.target===modal) modal.style.display="none"; });
function closeHistory(){ modal.style.display="none"; }

async function viewHistory(){
  const empId = empInput.value.trim();
  if(!empId){ alert("Enter Employee ID first"); return; }
  document.getElementById("historyContent").innerHTML="Loading...";
  modal.style.display="flex";
  try{
    const resp = await fetch(webAppUrl,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`action=getHistory&empId=${encodeURIComponent(empId)}`
    });
    const data = await resp.json();
    if(data.success && data.history){ historyData=data.history; renderHistoryTable(historyData); }
    else document.getElementById("historyContent").innerHTML="No history found.";
  } catch{ document.getElementById("historyContent").innerHTML="Error fetching history."; }
}

function renderHistoryTable(records){
  if(!records.length){ document.getElementById("historyContent").innerHTML="No records found."; return; }
  let html = `<table><tr><th>Date</th><th>Time</th><th>Shift</th><th>Location</th><th>Work Duration</th></tr>`;
  records.forEach(r=>{
    html += `<tr>
      <td>${r.date||""}</td>
      <td>Check-In: ${r.checkInTime||""}<br>Check-Out: ${r.checkOutTime||""}</td>
      <td>Check-In: ${r.checkInShift||""}<br>Check-Out: ${r.checkOutShift||""}</td>
      <td>Check-In: ${r.checkInLatitude||""},${r.checkInLongitude||""}<br>Check-Out: ${r.checkOutLatitude||""},${r.checkOutLongitude||""}</td>
      <td>${r.workDuration||""}</td>
    </tr>`;
  });
  html += "</table>"; document.getElementById("historyContent").innerHTML = html;
}

// DOWNLOAD CSV
function downloadHistory(){
  if(!historyData.length){ alert("No history available. Please fetch history first."); return; }
  let csv = "Date,Check-In Time,Check-In Shift,Check-In Location,Check-Out Time,Check-Out Shift,Check-Out Location,Work Duration\n";
  historyData.forEach(r=>{
    const ci = `${r.checkInLatitude||""},${r.checkInLongitude||""}`;
    const co = `${r.checkOutLatitude||""},${r.checkOutLongitude||""}`;
    csv += `"${r.date||""}","${r.checkInTime||""}","${r.checkInShift||""}","${ci}","${r.checkOutTime||""}","${r.checkOutShift||""}","${co}","${r.workDuration||""}"\n`;
  });
  const blob = new Blob([csv], { type:"text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download="attendance_history.csv";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
</script>
</body>
</html>
